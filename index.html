<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Icesi Globe</title>
  <link href="css/css2.css" rel="stylesheet" />
  <script src="js/turf.min.js"></script>
  <link rel="stylesheet" href="css/index.css" />
</head>

<body>
  <header>Icesi Globe</header>
  <div id="globeViz"></div>

  <div class="controls">
    <select id="country1" class="country-select"></select>
    <select id="country2" class="country-select"></select>
    <div class="optimization-criteria">
      <label for="criteria">Optimizar por:</label>
      <select id="criteria">
        <option value="precio" selected>Precio</option>
        <option value="tiempo">Tiempo</option>
        <option value="escalas">Escalas</option>
      </select>
    </div>
    <button id="generateArc">Generar Ruta</button>
    <button id="clearRoute" class="clear-button">Limpiar Ruta</button>
  </div>

  <div id="countryModal" class="modal"></div>
  <div id="tripInfo" class="trip-info"></div>

  <script src="js/globe.js"></script>
  <script src="scripts/dijkstra.js"></script>

  <script>
    let arcsData = [];
    let countriesData = {};
    let flightGraph = {};
    let countryCentroids = {};
    let countryNameToIdMap = {};
    let idToCountryNameMap = {};
    let countryNamesToSpanish = {};

    function calculateHaversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    Promise.all([
      fetch("data/countries.json").then((res) => res.json()),
      fetch("data/realistic_flight_graph.json").then((res) => res.json()),
      fetch("data/world_with_ids.json").then((res) => res.json()),
    ]).then(([countries, graph, worldData]) => {
      countriesData = countries;
      flightGraph = graph;

      Object.keys(countriesData).forEach((id) => {
        countryNameToIdMap[countriesData[id].name] = id;
        idToCountryNameMap[id] = countriesData[id].name;
      });
      
      Object.values(countriesData).forEach(country => {
        countryNamesToSpanish[country.name] = country.spanish_name;
      });

      Object.keys(countriesData).forEach((id) => {
        const country = countriesData[id];
        if (country.lat && country.lon) {
          countryCentroids[country.name] = [country.lon, country.lat];
        }
      });

      const world = Globe()
        .globeImageUrl("water-texture.png")
        .backgroundImageUrl("./night-sky.png")
        .backgroundColor("black")(document.getElementById("globeViz"));
      
      window.world = world;

      function centerGlobeView(points) {
        if (!points || points.length === 0) return;
        
        if (points.length === 1) {
          const [lng, lat] = points[0];
          world.pointOfView({ lat, lng, altitude: 2.5 }, 1000);
          return;
        }
        
        let sumLat = 0, sumLng = 0;
        points.forEach(point => {
          sumLng += point[0];
          sumLat += point[1];
        });
        
        const avgLng = sumLng / points.length;
        const avgLat = sumLat / points.length;
        
        let maxDist = 0;
        for (let i = 0; i < points.length; i++) {
          for (let j = i + 1; j < points.length; j++) {
            const startPoint = turf.point(points[i]);
            const endPoint = turf.point(points[j]);
            const dist = turf.distance(startPoint, endPoint);
            maxDist = Math.max(maxDist, dist);
          }
        }
        
        const altitude = Math.max(1.5, Math.min(4, 1.5 + maxDist / 5000));
        
        world.pointOfView({ lat: avgLat, lng: avgLng, altitude }, 1000);
      }

      world
        .polygonsData(worldData.features)
        .polygonCapColor(() => "#183eb4")
        .polygonSideColor(() => "rgba(0, 0, 0, 0.0)")
        .polygonStrokeColor(() => "#020a73")
        .onPolygonClick((feature) => showCountryInfo(feature.properties.name));

      let countryNames = [];
      
      if (worldData.features && worldData.features.length > 0) {
        countryNames = worldData.features.map((f) => f.properties.name).sort();
      } else {
        countryNames = Object.values(countriesData).map(country => country.name).sort();
      }
      
      const country1Select = document.getElementById("country1");
      const country2Select = document.getElementById("country2");
      
      country1Select.innerHTML = '<option value="" disabled selected>País de origen</option>';
      country2Select.innerHTML = '<option value="" disabled selected>País de destino</option>';
      
      countryNames.forEach((name) => {
        const spanishName = countryNamesToSpanish[name] || name;
        
        const option1 = document.createElement('option');
        option1.value = name;
        option1.textContent = spanishName;
        country1Select.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = name;
        option2.textContent = spanishName;
        country2Select.appendChild(option2);
      });

      document.getElementById("generateArc").addEventListener("click", () => {
        const country1 = country1Select.value;
        const country2 = country2Select.value;
        const criteria = document.getElementById("criteria").value;

        if (!country1 || !country2 || country1 === country2) {
          alert("Selecciona dos países diferentes");
          return;
        }

        const id1 = countryNameToIdMap[country1];
        const id2 = countryNameToIdMap[country2];
        
        const path = dijkstraPath(flightGraph, id1, id2, criteria);

        if (!path.length) {
          alert("No existe una ruta entre estos países.");
          return;
        }

        let totalPrice = 0;
        let totalDistance = 0;
        let totalTime = 0;
        let totalWeightedMetric = 0;
        arcsData = [];
        const routePoints = [];

        for (let i = 0; i < path.length - 1; i++) {
          const fromId = path[i];
          const toId = path[i + 1];
          const connection = flightGraph[fromId].connections[toId];

          totalPrice += connection.price_usd;

          const fromName = idToCountryNameMap[fromId];
          const toName = idToCountryNameMap[toId];
          
          const startLat = countriesData[fromId].lat;
          const startLon = countriesData[fromId].lon;
          const endLat = countriesData[toId].lat;
          const endLon = countriesData[toId].lon;

          if (startLat && startLon && endLat && endLon) {
            const startPoint = [startLon, startLat];
            const endPoint = [endLon, endLat];
            
            const startExists = routePoints.some(p => p[0] === startLon && p[1] === startLat);
            const endExists = routePoints.some(p => p[0] === endLon && p[1] === endLat);
            
            if (!startExists) routePoints.push(startPoint);
            if (!endExists) routePoints.push(endPoint);
            
            const distance = calculateHaversineDistance(startLat, startLon, endLat, endLon);
            totalDistance += distance;
            totalTime += connection.duration_hours;
            
            const weightedValue = calculateDistance(criteria, connection);
            totalWeightedMetric += weightedValue;
            
            arcsData.push({
              startLat: startLat,
              startLng: startLon,
              endLat: endLat,
              endLng: endLon,
              color: `hsl(${Math.random() * 360}, 70%, 50%)`,
            });
          }
        }

        world
          .arcsData(arcsData)
          .arcAltitudeAutoScale(0.5)
          .arcStroke(0.5)
          .arcDashLength(0.1)
          .arcDashGap(0.03)
          .arcDashAnimateTime(3000);

        const routeNames = new Set(path.map((id) => idToCountryNameMap[id]));
        world.polygonCapColor((feature) =>
          routeNames.has(feature.properties.name) ? "#386ee4" : "#183eb4"
        );

        centerGlobeView(routePoints);

        const country1Spanish = countryNamesToSpanish[country1] || country1;
        const country2Spanish = countryNamesToSpanish[country2] || country2;
        
        showTripInfo(country1Spanish, country2Spanish, totalPrice, totalDistance, path, criteria, totalWeightedMetric, totalTime);
      });
    });

    function showCountryInfo(countryName) {
      const id = countryNameToIdMap[countryName];
      if (!id || !countriesData[id]) return;
      
      const country = countriesData[id];
      
      const modal = document.getElementById("countryModal");
      modal.innerHTML = `
        <div class="modal-header">
          ${country.spanish_name}
          <span class="modal-close">&times;</span>
        </div>
        <div class="modal-content">
          <div class="modal-section">
            <h4>Descripción</h4>
            <p>${country.info.description}</p>
          </div>
          
          <div class="modal-section">
            <h4>Clima</h4>
            <p>${country.info.climate}</p>
          </div>
          
          <div class="modal-section">
            <h4>Atracciones Turísticas</h4>
            <ul class="attraction-list">
              ${country.info.attractions.map(attraction => `<li>${attraction}</li>`).join('')}
            </ul>
          </div>
          
          <div class="modal-section">
            <h4>Curiosidades</h4>
            <ul class="curiosity-list">
              ${country.info.curiosities.map(curiosity => `<li>${curiosity}</li>`).join('')}
            </ul>
          </div>
        </div>
      `;
      modal.style.display = "block";

      modal.querySelector(".modal-close").addEventListener("click", () => {
        modal.style.display = "none";
      });
    }
    
    function addMobileToggleButtons() {
      if (window.innerWidth <= 768) {
        const tripInfo = document.getElementById("tripInfo");
        if (tripInfo && tripInfo.style.display === "block") {
          let toggleBtn = document.querySelector('.mobile-toggle-info');
          if (!toggleBtn) {
            toggleBtn = document.createElement('div');
            toggleBtn.className = 'mobile-toggle-info';
            toggleBtn.innerHTML = '↕️';
            toggleBtn.title = 'Expandir/Contraer información';
            document.body.appendChild(toggleBtn);
            
            let isExpanded = true;
            
            toggleBtn.addEventListener('click', () => {
              if (isExpanded) {
                tripInfo.style.maxHeight = '80px';
                tripInfo.style.overflow = 'hidden';
                toggleBtn.innerHTML = '↓';
              } else {
                tripInfo.style.maxHeight = 'calc(60vh - 20px)';
                tripInfo.style.overflow = 'auto';
                toggleBtn.innerHTML = '↕️';
              }
              isExpanded = !isExpanded;
            });
          }
        } else {
          const existingBtn = document.querySelector('.mobile-toggle-info');
          if (existingBtn) {
            existingBtn.remove();
          }
        }
      }
    }
    
    function showTripInfo(from, to, price, distance, path, criteria, weightedMetric, flightTime) {
      const infoBox = document.getElementById("tripInfo");
      const flightTimeString = flightTime.toFixed(1);
      
      const stops = path.map((id) => {
        const engName = idToCountryNameMap[id];
        return countryNamesToSpanish[engName] || engName;
      }).join(" → ");
      
      let optimizedBy = getOptimizationName(criteria);
      
      let optimizationDetails = "";
      
      if (criteria === 'precio') {
        optimizationDetails = `
          <p class="optimization-detail">
            <small>Valor optimizado: $${weightedMetric.toFixed(2)} USD</small>
          </p>
        `;
      } else if (criteria === 'tiempo') {
        optimizationDetails = `
          <p class="optimization-detail">
            <small>Valor optimizado: ${weightedMetric.toFixed(2)} horas</small>
          </p>
        `;
      } else if (criteria === 'escalas') {
        optimizationDetails = `
          <p class="optimization-detail">
            <small>Valor optimizado: ${path.length - 1} escalas</small>
          </p>
        `;
      }

      infoBox.innerHTML = `
        <div class="trip-info-header">
          Información del Viaje
        </div>
        <div class="trip-info-content">
          <div class="trip-info-section">
            <h3>Detalles del Itinerario</h3>
            <p><strong>Origen:</strong> ${from}</p>
            <p><strong>Destino:</strong> ${to}</p>
            <p><strong>Optimización:</strong> ${optimizedBy} <span class="trip-info-badge">Ruta óptima</span></p>
            ${optimizationDetails}
          </div>
          
          <div class="trip-info-section">
            <h3>Ruta del Viaje</h3>
            <div class="trip-info-route">
              ${stops}
            </div>
            <p><small>La ruta pasa por ${path.length} países con ${path.length - 2} escalas</small></p>
          </div>
          
          <div class="trip-info-section">
            <h3>Métricas del Viaje</h3>
            <div class="trip-info-metrics">
              <div class="trip-info-metric">
                <div class="metric-value">$${price.toFixed(2)}</div>
                <div class="metric-label">USD</div>
              </div>
              <div class="trip-info-metric">
                <div class="metric-value">${distance.toFixed(0)}</div>
                <div class="metric-label">kilómetros</div>
              </div>
              <div class="trip-info-metric">
                <div class="metric-value">${flightTimeString}</div>
                <div class="metric-label">horas de vuelo</div>
              </div>
              <div class="trip-info-metric">
                <div class="metric-value">${path.length - 2}</div>
                <div class="metric-label">escalas</div>
              </div>
            </div>
          </div>
          
          <button id="closeTripInfo">Cerrar</button>
        </div>
      `;
      
      infoBox.style.display = "block";
      
      document.getElementById("closeTripInfo").addEventListener("click", () => {
        infoBox.style.display = "none";
        const toggleBtn = document.querySelector('.mobile-toggle-info');
        if (toggleBtn) toggleBtn.remove();
      });
      
      addMobileToggleButtons();
    }
    
    function getOptimizationName(type) {
      const names = {
        'precio': 'Menor precio',
        'tiempo': 'Menor tiempo',
        'escalas': 'Menos escalas'
      };
      return names[type] || type;
    }
    
    window.addEventListener('resize', () => {
      if (arcsData.length > 0) {
        const routePoints = [];
        arcsData.forEach(arc => {
          const startPoint = [arc.startLng, arc.startLat];
          const endPoint = [arc.endLng, arc.endLat];
          
          const startExists = routePoints.some(p => p[0] === arc.startLng && p[1] === arc.startLat);
          const endExists = routePoints.some(p => p[0] === arc.endLng && p[1] === arc.endLat);
          
          if (!startExists) routePoints.push(startPoint);
          if (!endExists) routePoints.push(endPoint);
        });
        
        if (typeof centerGlobeView === 'function' && routePoints.length > 0) {
          centerGlobeView(routePoints);
        }
      }
      
      addMobileToggleButtons();
    });
    
    // ------------ Para dispositivos móviles ------------
    document.addEventListener('touchstart', (e) => {
      const modal = document.getElementById("countryModal");
      const tripInfo = document.getElementById("tripInfo");
      const controls = document.querySelector('.controls');
      
      if (modal.style.display === 'block' && 
          !modal.contains(e.target) && 
          e.target !== modal) {
        modal.style.display = 'none';
      }
      
    });

    function setupTouchInteractions() {
      document.getElementById('globeViz').addEventListener('touchmove', function(e) {
        if (e.touches.length > 1) {
          e.preventDefault();
        }
      }, { passive: false });
      
      window.addEventListener('orientationchange', function() {
        setTimeout(() => {
          if (arcsData.length > 0) {
            const routePoints = [];
            arcsData.forEach(arc => {
              const startPoint = [arc.startLng, arc.startLat];
              const endPoint = [arc.endLng, arc.endLat];
              
              const startExists = routePoints.some(p => p[0] === arc.startLng && p[1] === arc.startLat);
              const endExists = routePoints.some(p => p[0] === arc.endLng && p[1] === arc.endLat);
              
              if (!startExists) routePoints.push(startPoint);
              if (!endExists) routePoints.push(endPoint);
            });
            
            if (typeof centerGlobeView === 'function' && routePoints.length > 0) {
              centerGlobeView(routePoints);
            }
          }
        }, 300);r
      });
    }
    
    function updateMobileUI() {
      const isMobile = window.innerWidth < 768 || /Mobi|Android/i.test(navigator.userAgent);
      
      if (isMobile) {
        document.body.classList.add('mobile-device');
      } else {
        document.body.classList.remove('mobile-device');
      }
    }
    
    // ------------ Función de borrar ruta ------------
    document.getElementById("clearRoute").addEventListener("click", clearCurrentRoute);

    document.addEventListener('DOMContentLoaded', function() {
      setupTouchInteractions();
      updateMobileUI();
      
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
          clearCurrentRoute();
        }
      });
    });
    
    function clearCurrentRoute() {
      const country1Select = document.getElementById("country1");
      const country2Select = document.getElementById("country2");
      country1Select.selectedIndex = 0;
      country2Select.selectedIndex = 0;
      
      const tripInfo = document.getElementById("tripInfo");
      tripInfo.style.display = "none";
      
      const countryModal = document.getElementById("countryModal");
      countryModal.style.display = "none";
      
      if (window.world) {
        window.world.arcsData([]);
        
        window.world.polygonCapColor(() => "#183eb4");
        window.world.pointOfView({ lat: 0, lng: 0, altitude: 2.5 }, 1000);
      }
      
      arcsData = [];
    }
    
    window.addEventListener('resize', updateMobileUI);
  </script>
</body>

</html>
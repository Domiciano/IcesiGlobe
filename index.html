<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Globo Minimalista con Arcos</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
    <style>
        * {
            font-family: 'Inter', sans-serif;
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            height: 100%;
            background-color: #f0f0f0;
        }

        header {
            background-color: #183eb4;
            color: white;
            padding: 1rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }

        #globeViz {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 60px;
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 100;
        }

        select, button {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }

        .choices__inner {
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            min-width: 200px;
            padding: 4px;
        }

        .choices__list--dropdown {
            border: 1px solid #ccc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 80px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 300px;
        }

        .modal h3 { margin-top: 0; }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        .trip-info {
            display: none;
            position: absolute;
            top: 80px;
            left: 20px;
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 250px;
        }
    </style>
</head>

<body>
    <header>Icesi Globe</header>
    <div id="globeViz"></div>

    <div class="controls">
        <select id="country1"></select>
        <select id="country2"></select>
        <button id="generateArc">Generar Arco</button>
    </div>

    <div id="countryModal" class="modal"></div>
    <div id="tripInfo" class="trip-info"></div>

    <script src="https://cdn.jsdelivr.net/npm/globe.gl@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

    <script>
        let arcsData = [];
        let countriesData = {};
        const countriesToHighlight = [];

        fetch('data/countries.json')
            .then(res => res.json())
            .then(data => countriesData = data)
            .catch(err => console.error('Error loading countries data:', err));

        const initSearchSelect = (element) => new Choices(element, {
            searchEnabled: true,
            removeItemButton: true,
            classNames: {
                containerInner: 'choices__inner',
                input: 'choices__input',
            }
        });

        const selectCountry1 = initSearchSelect('#country1');
        const selectCountry2 = initSearchSelect('#country2');
        const generateArcButton = document.getElementById('generateArc');

        fetch('data/world_with_ids.json')
            .then(res => res.json())
            .then(countries => {
                const world = Globe()
                    .globeImageUrl('water-texture.png')
                    .backgroundImageUrl('./night-sky.png')
                    .backgroundColor('black')
                    (document.getElementById('globeViz'));

                world.onPolygonClick(feature => {
                    const countryName = feature.properties.name;
                    showCountryInfo(countryName);
                });

                const countryNames = countries.features.map(f => f.properties.name).sort();
                countryNames.forEach(name => {
                    selectCountry1.setChoices([{value: name, label: name}]);
                    selectCountry2.setChoices([{value: name, label: name}]);
                });

                world.polygonsData(countries.features)
                    .polygonCapColor(feature => '#183eb4')
                    .polygonSideColor(() => 'rgba(0, 0, 0, 0.0)')
                    .polygonStrokeColor(() => '#020a73')
                    .polygonsTransitionDuration(300);

                generateArcButton.addEventListener('click', () => {
                    const country1 = selectCountry1.getValue(true);
                    const country2 = selectCountry2.getValue(true);

                    if (!country1 || !country2 || country1 === country2) {
                        alert('Por favor, selecciona dos países diferentes.');
                        return;
                    }

                    arcsData = [];
                    updateArcs(world);

                    countriesToHighlight.length = 0;
                    countriesToHighlight.push(country1, country2);
                    world.polygonCapColor(feature =>
                        countriesToHighlight.includes(feature.properties.name) ? '#386ee4' : '#183eb4'
                    );

                    createArc(world, country1, country2);
                });
            })
            .catch(err => console.error('Error al cargar el archivo JSON:', err));

        function updateArcs(world) {
            world.arcsData(arcsData)
                .arcAltitudeAutoScale(0.5)
                .arcStroke(0.5)
                .arcDashLength(0.1)
                .arcDashGap(0.03)
                .arcColor('color')
                .arcDashAnimateTime(3000);
        }

        async function createArc(world, country1, country2) {
            const getCoords = async country => {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${country}&format=jsonv2`);
                const data = await res.json();
                return { lat: data[0].lat, lng: data[0].lon };
            };

            try {
                const [start, end] = await Promise.all([getCoords(country1), getCoords(country2)]);

                arcsData.push({
                    startLat: start.lat,
                    startLng: start.lng,
                    endLat: end.lat,
                    endLng: end.lng,
                    color: '#fff'
                });

                updateArcs(world);
                showTripInfo(country1, country2);
            } catch (error) {
                console.error('Error creando arco:', error);
            }
        }

        function showTripInfo(from, to) {
            const infoBox = document.getElementById('tripInfo');
            const now = new Date().toLocaleString();
            infoBox.innerHTML = `
                <strong>Trip Info</strong>
                <p>From: ${from}</p>
                <p>To: ${to}</p>
                <p>Generated: ${now}</p>
            `;
            infoBox.style.display = 'block';
        }

        function showCountryInfo(countryName) {
            const country = Object.values(countriesData).find(c => c.name === countryName);
            if (!country) return;

            const modal = document.getElementById('countryModal');
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="modal-close" onclick="document.getElementById('countryModal').style.display='none'">&times;</span>
                    <h3>${country.spanish_name}</h3>
                    <p><strong>Descripción:</strong> ${country.info.description}</p>
                    <p><strong>Clima:</strong> ${country.info.climate}</p>
                    <p><strong>Atracciones:</strong> ${country.info.attractions.join(', ')}</p>
                    <p><strong>Curiosidades:</strong> ${country.info.curiosities.join(', ')}</p>
                </div>
            `;
            modal.style.display = 'block';
        }
    </script>
</body>

</html>
